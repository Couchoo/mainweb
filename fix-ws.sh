#!/bin/bash

echo "------------------------------------------"
echo "üõ†Ô∏è Couchoo WS Fixer v1.2"
echo "------------------------------------------"

# 1. Install Go
echo "üì¶ –°—Ç–µ–ø–µ–Ω 1: –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–µ –Ω–∞ Go..."
sudo apt update && sudo apt install -y golang-go

# 2. Check Go version
go version

# 3. Build the server
echo "üèóÔ∏è –°—Ç–µ–ø–µ–Ω 2: –ö–æ–º–ø–∏–ª–∏—Ä–∞–Ω–µ –Ω–∞ –±—Ä–æ—è—á–∞..."
cd /root/mainweb/cinema-ws
rm -f ws-server # –ò–∑—Ç—Ä–∏–≤–∞–º–µ —Å—Ç–∞—Ä–∞ –≤–µ—Ä—Å–∏—è –∞–∫–æ –∏–º–∞
go mod tidy
go build -o ws-server

if [ -f "ws-server" ]; then
    echo "‚úÖ –ö–æ–º–ø–∏–ª–∏—Ä–∞–Ω–µ—Ç–æ –µ —É—Å–ø–µ—à–Ω–æ!"
else
    echo "‚ùå –ì–†–ï–®–ö–ê: –°—ä—Ä–≤—ä—Ä—ä—Ç –Ω–µ –º–æ–∂–∞ –¥–∞ —Å–µ –∫–æ–º–ø–∏–ª–∏—Ä–∞!"
    exit 1
fi

# 4. Fix PM2
echo "üíæ –°—Ç–µ–ø–µ–Ω 3: –†–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ PM2..."
pm2 delete WS 2>/dev/null

# –û–ø–∏—Ç–≤–∞–º–µ —Å–µ –¥–∞ –∑–∞—Ä–µ–¥–∏–º –ø—Ä–æ–º–µ–Ω–ª–∏–≤–∏—Ç–µ –æ—Ç .env –∞–∫–æ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞
if [ -f "/root/mainweb/.env" ]; then
    echo "üìù –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç .env..."
    export $(grep -v '^#' /root/mainweb/.env | xargs)
fi

# –°—Ç–∞—Ä—Ç–∏—Ä–∞–º–µ —Å –∏–∑—Ä–∏—á–Ω–æ –ø—Ä–µ–¥–∞–≤–∞–Ω–µ –Ω–∞ —Å–µ–∫—Ä–µ—Ç–∞
pm2 start ./ws-server --name "WS" --update-env
pm2 save

echo "------------------------------------------"
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ—Ä—Ç–æ–≤–µ—Ç–µ (—Ç—Ä—è–±–≤–∞ –¥–∞ –≤–∏–∂–¥–∞—à 8080):"
netstat -tulpen | grep 8080

echo "------------------------------------------"
echo "‚úÖ –ì–û–¢–û–í–û! –ü—Ä–æ–≤–µ—Ä–∏ —Å–∞–π—Ç–∞ —Å–ª–µ–¥ 10 —Å–µ–∫—É–Ω–¥–∏."
pm2 list
